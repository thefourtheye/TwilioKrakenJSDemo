<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta name="description" content=""/>
    <meta name="author" content=""/>
    <link rel="shortcut icon" href="assets/ico/favicon.ico"/>

    <title>{+title /}</title>

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Custom styles for this template -->
    <link href="css/jumbotron-narrow.css" rel="stylesheet"/>

    <link href='http://fonts.googleapis.com/css?family=PT+Serif' rel='stylesheet' type='text/css'/>

    <script src="js/jquery-2.1.1.js"></script>
    <script src="js/bootstrap.js"></script>
    <script src="select2-3.4.8/select2.js"></script>
    <link href="select2-3.4.8/select2.css" rel="stylesheet"/>

    <style type="text/css">
        a {
            font-size: 18px;
            font-family:"PT Serif";
        }
        .ptserif {
            font-family:"PT Serif";
        }
        .mainbox {
            background-color: #f9f9f9;
            display: block;
            -webkit-margin-before: 1em;
            -webkit-margin-after: 1em;
            -webkit-margin-start: 0px;
            -webkit-margin-end: 0px;
            margin-top: 10px;
            margin-right: 0px;
            margin-bottom: 10px;
            margin-left: 0px;
            border-radius: 12px;
            padding-top: 14px;
            padding-right: 24px;
            padding-bottom: 14px;
            padding-left: 24px;
            height: 400px;
        }
    </style>
    <script>
        function LocalCache() {
            var cache = {};
            return {
                "clearCache": function (tableName) {
                    if (Object.prototype.toString.call(tableName).indexOf("String") + 1 && tableName) {
                        cache[tableName.toLowerCase()] = {};
                    }
                },
                "reloadCache": function (tableName) {
                    if (Object.prototype.toString.call(tableName).indexOf("String") + 1 && tableName) {
                        $.ajax("/loadtables", {
                            "type": "POST",
                            "data": {
                                "_csrf": $("#_csrf").val(),
                                "tablename": tableName
                            },
                            "error": function() {
                                alert("Loading " + tableName + " failed!");
                            }
                        }).done(function(data) {
                            cache[tableName.toLowerCase()] = data;
                        });
                    }
                },
                "get": function(tableName) {
                    return cache[tableName.toLowerCase()];
                }
            }
        }

        var Cache = new LocalCache(),
            CallBoxOptions = {
                id: function(currentObject) {
                    return currentObject.ID;
                },
                formatResult: function formatResult(currentObject) {
                    return "<div id='id" + currentObject.ID + "'>" +
                        (currentObject.Name ? "<h4>" + currentObject.Name + "</h4>" : "") +
                        "+" + currentObject.CountryCode + " " + currentObject.Number + "</div>";
                },
                formatSelection: function formatSelection(currentObject) {
                    return "<div id='id" + currentObject.ID + "'>" +
                        (currentObject.Number? "<b>" + "+" + currentObject.CountryCode + " "
                            + currentObject.Number + "</b> - " : "") +
                        currentObject.Name + "</div>";
                },
                query: function(query) {
                    var term = query.term.toLowerCase();
                    query.callback({
                        "results": (function() {
                            var temp = (Cache.get("Contacts") || []).filter(function(currentObject) {
                                return currentObject.Name.toLowerCase().indexOf(term) + 1 ||
                                    currentObject.Number.toLowerCase().indexOf(term) + 1;
                            });
                            if (!temp.length) {
                                temp.push({
                                    ID: "Custom" + term,
                                    Name: term,
                                    Number: ""
                                });
                            }
                            return temp;
                        })()
                    });
                    $("#callKey").select2('data', null);
                    $("#callKey").select2('val', "");
                    $("#callKey").val('');
                }
            },
            ContactsBoxOptions = {
                id: function(currentObject) {
                    return currentObject.ID;
                },
                formatResult: function formatResult(currentObject) {
                    return "<div id='id" + currentObject.ID + "'>" +
                        (currentObject.Name ? "<h4>" + currentObject.Name + "</h4>" : "") +
                        "+" + currentObject.CountryCode + " " + currentObject.Number + "</div>";
                },
                formatSelection: function formatSelection(currentObject) {
                    return "<div id='id" + currentObject.ID + "'>" +
                        (currentObject.Number? "<b>" + "+" + currentObject.CountryCode + " "
                            + currentObject.Number + "</b> - " : "") +
                        currentObject.Name + "</div>";
                },
                query: function(query) {
                    var term = query.term.toLowerCase();
                    query.callback({
                        "results": (Cache.get("Contacts") || []).filter(function(currentObject) {
                                return currentObject.Name.toLowerCase().indexOf(term) + 1 ||
                                    currentObject.Number.toLowerCase().indexOf(term) + 1;
                            })
                    });
                    $("#contactsSearch").select2('data', null);
                    $("#contactsSearch").select2('val', "");
                    $("#contactsSearch").val("");
                }
            };

        $(document).ready(function() {
            Cache.reloadCache("Contacts");
            Cache.reloadCache("SpeedDial");
            Cache.reloadCache("CallLogs");

            $("#callKey").select2(CallBoxOptions);

            $("#contactsSearch").select2(ContactsBoxOptions);

            $('#myTabs a').click(function (e) {
                e.preventDefault();
                $(this).tab('show');
            });

        });
    </script>
</head>

<body class="ptserif">
    <div class="container">
        <div class="header" style="text-align: center">
            <h1 class="text ptserif"><b></b></h1>
        </div>

        <center>
            <ul id="myTabs" class="nav nav-tabs">
                <li class="active"><a href="#dialer" data-toggle="tab">Dialer</a></li>
                <li><a href="#contacts" data-toggle="tab">Contacts</a></li>
                <li><a href="#" data-toggle="tab">Speed Dial</a></li>
            </ul>

            <div class="tab-content">
                <div id="dialer" class="ptserif mainbox tab-pane fade in active">
                    {+dialerBody /}
                </div>

                <div id="contacts" class="ptserif mainbox tab-pane fade">
                    {+contactsBody /}
                </div>

                <div id="speeddial" class="ptserif mainbox tab-pane fade">
                    {+dialerBody /}
                </div>
            </div>

        </center>
        <br/>
        <div class="footer"/>
    </div>
</body>
</html>
